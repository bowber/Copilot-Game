name: ğŸ§ª Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  pull_request_review:
    types: [ submitted ]
  pull_request_target:
    types: [ review_requested ]

jobs:
  rust-tests:
    name: ğŸ¦€ Rust Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./game
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: ğŸ“¦ Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ./game/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ” Check Rust formatting
        run: cargo fmt --all -- --check

      - name: ğŸ” Run Clippy lints
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: ğŸ§ª Run Rust tests
        run: cargo test --verbose

      - name: ğŸ—ï¸ Test WASM build
        run: |
          cargo install wasm-pack --locked
          wasm-pack build --target web --out-dir pkg

  frontend-tests:
    name: âš¡ Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ui
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './ui/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” TypeScript type check
        run: npx tsc --noEmit

      - name: ğŸ§ª Run frontend tests
        run: npm test run

      - name: ğŸ—ï¸ Test frontend build
        run: npm run build

  integration-tests:
    name: ğŸ”„ Integration Tests
    runs-on: ubuntu-latest
    needs: [rust-tests, frontend-tests]
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './ui/package-lock.json'

      - name: ğŸ”§ Install wasm-pack
        run: cargo install wasm-pack --locked

      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./ui
        run: npm ci

      - name: ğŸ—ï¸ Build complete application
        working-directory: ./ui
        run: |
          npm run build-game
          npm run build

      - name: âœ… Verify build artifacts
        run: |
          test -f game/pkg/game.js || (echo "âŒ WASM bindings not generated" && exit 1)
          test -f game/pkg/game_bg.wasm || (echo "âŒ WASM file not generated" && exit 1)
          test -d ui/dist || (echo "âŒ Frontend build not generated" && exit 1)
          echo "âœ… All build artifacts present"

      - name: ğŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            game/pkg/
            ui/dist/
          retention-days: 7

  code-quality:
    name: ğŸ“Š Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './ui/package-lock.json'

      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./ui
        run: npm ci

      - name: ğŸ” Check Rust code formatting
        working-directory: ./game
        run: cargo fmt --all -- --check

      - name: ğŸ” Advanced Rust linting
        working-directory: ./game
        run: cargo clippy --all-targets --all-features -- -D warnings -D clippy::all

      - name: ğŸ” TypeScript strict checks
        working-directory: ./ui
        run: npx tsc --noEmit --strict

      - name: ğŸ“ Check file sizes
        run: |
          echo "ğŸ” Checking repository file sizes..."
          find . -type f -name "*.rs" -exec wc -l {} + | tail -1 | awk '{print "Rust lines: " $1}'
          find . -type f -name "*.ts" -o -name "*.tsx" -exec wc -l {} + | tail -1 | awk '{print "TypeScript lines: " $1}'
          
      - name: ğŸ”’ Security audit
        working-directory: ./ui
        run: npm audit --audit-level=moderate

  performance-check:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    needs: [integration-tests]
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”§ Install tools
        run: |
          cargo install wasm-pack --locked
          npm install -g npm@latest

      - name: ğŸ“Š WASM size check
        working-directory: ./game
        run: |
          wasm-pack build --target web --out-dir pkg --release
          echo "ğŸ¦€ WASM bundle sizes:"
          ls -lah pkg/*.wasm | awk '{print $5 " " $9}'
          
          # Check if WASM is under reasonable size limit (1MB)
          size=$(stat -c%s "pkg/game_bg.wasm")
          if [ $size -gt 1048576 ]; then
            echo "âš ï¸  WASM bundle is larger than 1MB ($size bytes)"
            echo "Consider optimizing for size"
          else
            echo "âœ… WASM bundle size is optimal ($size bytes)"
          fi

      - name: ğŸ“Š Frontend bundle analysis
        working-directory: ./ui
        run: |
          npm ci
          npm run build-game
          npm run build
          echo "âš¡ Frontend bundle sizes:"
          ls -lah dist/assets/ | grep -E '\.(js|css)$' | awk '{print $5 " " $9}'